# ===================================================================
#  CONFIGURAÇÕES GLOBAIS
# ===================================================================
worker_processes  auto;
pid               logs/nginx.pid;
error_log         logs/error.log;

# ===================================================================
#  BLOCO DE EVENTOS
# ===================================================================
events {
    worker_connections  1024;
}

# ===================================================================
#  BLOCO HTTP PRINCIPAL
# ===================================================================
http {
    server_names_hash_bucket_size 128;
    include                       mime.types;
    default_type                  application/octet-stream;
    access_log                    logs/access.log;

    # -- Otimizações de Performance --
    sendfile            on;
    tcp_nopush          on;
    keepalive_timeout   65;
    gzip                on;

    # ===================================================================
    #  UPSTREAM PARA O BACKEND (DOCKER)
    # ===================================================================
    upstream avanade_gateway {
        # host.docker.internal aponta para a máquina host em ambientes Docker (Windows/Mac)
        server host.docker.internal:8080; 
    }

    # ===================================================================
    #  BACKEND: SERVIDOR ÚNICO PARA TODAS AS APIs
    # ===================================================================
    server {
        listen 80;
        server_name
            avanade.apigateway.com.br
            avanade.auth.api.com.br
            avanade.usuario.api.com.br
            avanade.vendas.api.com.br
            avanade.estoque.api.com.br;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name
            avanade.apigateway.com.br
            avanade.auth.api.com.br
            avanade.usuario.api.com.br
            avanade.vendas.api.com.br
            avanade.estoque.api.com.br;

        # O Nginx usa a variável $ssl_server_name para selecionar o certificado correto
        ssl_certificate      C:/avanade/nginx/certificates/$ssl_server_name-cert.pem;
        ssl_certificate_key  C:/avanade/nginx/certificates/$ssl_server_name-key.pem;

        location / {
            proxy_pass http://avanade_gateway;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # ===================================================================
    #  FRONTEND: App Principal (SINGLE-SPA na porta 900)
    # ===================================================================
    server {
        listen 80;
        server_name avanade.ecommerce.com.br;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name avanade.ecommerce.com.br;

        ssl_certificate     C:/avanade/nginx/certificates/avanade.ecommerce.com.br-cert.pem;
        ssl_certificate_key C:/avanade/nginx/certificates/avanade.ecommerce.com.br-key.pem;
        
		location / {
            proxy_pass http://127.0.0.1:9000;
            proxy_set_header Host $host;

            proxy_connect_timeout 3600s;
            proxy_read_timeout 3600;

            sub_filter 'http://avanade.ecommerce.com.br' 'https://avanade.ecommerce.com.br';
            sub_filter_once off;

            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
        }
	 
		# SERVIR ARQUIVOS ESTÁTICOS (PRINCIPAL)
		
		location /vendor/ {			
        alias C:/Avanade/App/front/avanade.single-root.front/src/vendor/;         
        expires 30d;
        access_log off;
		}	
		
    }

    # ===================================================================
    #  FRONTEND: Microfrontend MENU (porta 4201)
    # ===================================================================
    server {
        listen 80;
        server_name menu.avanade.front.com.br;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name menu.avanade.front.com.br;

        ssl_certificate      C:/avanade/nginx/certificates/menu.avanade.front.com.br-cert.pem;
        ssl_certificate_key  C:/avanade/nginx/certificates/menu.avanade.front.com.br-key.pem;

        location /ng-cli-ws/ {
			proxy_pass http://127.0.0.1:4201/ng-cli-ws/;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
		}
		
		
		location / {
			# Aponta para a raiz do servidor de desenvolvimento do Angular
			proxy_pass http://127.0.0.1:4201;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
    }

    # ===================================================================
    #  FRONTEND: Microfrontend HOME (porta 4202)
    # ===================================================================
    server {
        listen 80;
        server_name home.avanade.front.com.br;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name home.avanade.front.com.br;

        ssl_certificate      C:/avanade/nginx/certificates/home.avanade.front.com.br-cert.pem;
        ssl_certificate_key  C:/avanade/nginx/certificates/home.avanade.front.com.br-key.pem;
        
       location /ng-cli-ws/ {
			proxy_pass http://127.0.0.1:4202/ng-cli-ws/;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
		}
		
		
		location / {
			# Aponta para a raiz do servidor de desenvolvimento do Angular
			proxy_pass http://127.0.0.1:4202;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
    }

    # ===================================================================
    #  FRONTEND: Microfrontend ESTOQUE (porta 4203)
    # ===================================================================
    server {
        listen 80;
        server_name estoque.avanade.front.com.br;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name estoque.avanade.front.com.br;

        ssl_certificate      C:/avanade/nginx/certificates/estoque.avanade.front.com.br-cert.pem;
        ssl_certificate_key  C:/avanade/nginx/certificates/estoque.avanade.front.com.br-key.pem;
        
        location /ng-cli-ws/ {
			proxy_pass http://127.0.0.1:4203/ng-cli-ws/;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
		}
		
		
		location / {
			# Aponta para a raiz do servidor de desenvolvimento do Angular
			proxy_pass http://127.0.0.1:4203;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
    }

    # ===================================================================
    #  FRONTEND: Microfrontend VENDAS (porta 4204)
    # ===================================================================
    server {
        listen 80;
        server_name vendas.avanade.front.com.br;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name vendas.avanade.front.com.br;

        ssl_certificate      C:/avanade/nginx/certificates/vendas.avanade.front.com.br-cert.pem;
        ssl_certificate_key  C:/avanade/nginx/certificates/vendas.avanade.front.com.br-key.pem;
        
        location /ng-cli-ws/ {
			proxy_pass http://127.0.0.1:4204/ng-cli-ws/;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
		}
		
		
		location / {
			# Aponta para a raiz do servidor de desenvolvimento do Angular
			proxy_pass http://127.0.0.1:4204;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
    }

    # ===================================================================
    #  FRONTEND: Microfrontend USUARIO (porta 4205)
    # ===================================================================
    server {
        listen 80;
        server_name usuario.avanade.front.com.br;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name usuario.avanade.front.com.br;

        ssl_certificate      C:/avanade/nginx/certificates/usuario.avanade.front.com.br-cert.pem;
        ssl_certificate_key  C:/avanade/nginx/certificates/usuario.avanade.front.com.br-key.pem;
        
        location /ng-cli-ws/ {
			proxy_pass http://127.0.0.1:4205/ng-cli-ws/;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
		}
		
		
		location / {
			# Aponta para a raiz do servidor de desenvolvimento do Angular
			proxy_pass http://127.0.0.1:4205;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
    }
}
# --- Fim do Bloco HTTP ---