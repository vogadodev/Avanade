/* single-spa-layout@3.0.0 - umd */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("parse5/lib/tree-adapters/default.js"),require("path"),require("fs"),require("single-spa"),require("parse5/lib/parser/index.js"),require("parse5/lib/common/html.js"),require("parse5/lib/common/doctype.js"),require("stream"),require("merge2")):"function"==typeof define&&define.amd?define(["exports","parse5/lib/tree-adapters/default.js","path","fs","single-spa","parse5/lib/parser/index.js","parse5/lib/common/html.js","parse5/lib/common/doctype.js","stream","merge2"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).singleSpaLayout={},e.defaultTreeAdapter,e.path,e.fs,e.singleSpa,e.Parser,e.HTML,e.doctype,e.stream,e.merge2)}(this,(function(e,t,r,o,n,a,s,i,l,d){"use strict";function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=u(t),p=u(r),f=u(o),m=u(a),h=u(s),g=u(i),y=u(d);const N=Object.assign({},c.default,{isElementNode:e=>c.default.isElementNode(e)||e.type&&!e.type.startsWith("#"),getChildNodes:e=>c.default.getChildNodes(e)||e.routes,getTagName:e=>c.default.getTagName(e)||e.type,isCommentNode:e=>c.default.isCommentNode(e)||"#comment"===e.type,isTextNode:e=>c.default.isTextNode(e)||"#text"===e.type,getCommentNodeContent:e=>c.default.getCommentNodeContent(e)||e.value}),E="undefined"!=typeof window;function b(e,t){if("object"!=typeof t||Array.isArray(t)||null===t)throw Error(`Invalid ${e}: received ${Array.isArray(t)?"array":t} but expected a plain object`)}function v(e,t){if("boolean"!=typeof t)throw Error(`Invalid ${e}: received ${typeof t}, but expected a boolean`)}function w(e,t,r,o){if(o)return;const n=Object.keys(t),a=[];n.forEach((e=>{r.indexOf(e)<0&&a.push(e)})),a.length>0&&console.warn(Error(`Invalid ${e}: received invalid properties '${a.join(", ")}', but valid properties are ${r.join(", ")}`))}function T(e,t,r=!0){if("string"!=typeof t||r&&""===t.trim())throw Error(`Invalid ${e}: received '${t}', but expected a${r?" non-blank":""} string`)}function $(e,t){if(T(e,t),t.indexOf("/")<0)throw Error(`Invalid ${e}: received '${t}', but expected an absolute path that starts with /`)}function P(e,t,r,...o){if(!Array.isArray(t)&&("object"!=typeof typeof t||"number"!==t.length))throw Error(`Invalid ${e}: received '${t}', but expected an array`);for(let n=0;n<t.length;n++)r(t[n],`${e}[${n}]`,...o)}function S(e,t){T("path",t);const r={...e},o=e.base.slice(0,e.base.length-1);if(0===t.indexOf(o)){const o=E?window.location.origin:"http://localhost",n=new URL(C(o,t));r.routes=A(n,e.routes)}else r.routes=[];return r}function A(e,t){const r=[];return t.forEach((t=>{"application"===t.type?r.push(t):"route"===t.type?t.activeWhen(e)&&r.push({...t,routes:A(e,t.routes)}):Array.isArray(t.routes)?r.push({...t,routes:A(e,t.routes)}):r.push(t)})),r}function C(e,t){let r;return r="/"===e.substr(-1)?"/"===t[0]?e+t.slice(1):e+t:"/"===t[0]?e+t:e+"/"+t,"/"===r.substr(-1)&&r.length>1&&(r=r.slice(0,r.length-1)),r}const O="undefined"!=typeof Symbol?Symbol():"@";function x(e,t){if(E)return e.getAttribute(t);{const r=function(e,t){for(let r=0;r<e.length;r++)if(t(e[r]))return e[r];return null}(e.attrs,(e=>e.name===t.toLowerCase()));return r?r.value:null}}function L(e,t){return E?e.hasAttribute(t):e.attrs.some((e=>e.name===t))}function M(e,t,r){if("application"===e.nodeName.toLowerCase()){if(e.childNodes.length>0)throw Error("<application> elements must not have childNodes. You must put in a closing </application> - self closing is not allowed");const r={type:"application",name:x(e,"name")},o=x(e,"loader");if(o)if(t.loaders&&t.loaders.hasOwnProperty(o))r.loader=t.loaders[o];else if(E)throw Error(`Application loader '${o}' was not defined in the htmlLayoutData`);const n=x(e,"error");if(n)if(t.errors&&t.errors.hasOwnProperty(n))r.error=t.errors[n];else if(E)throw Error(`Application error handler '${o}' was not defined in the htmlLayoutData`);const a=x(e,"class");return a&&(r.className=a),R(e,r,t),[r]}if("route"===e.nodeName.toLowerCase()){const o={type:"route",routes:[]},n=x(e,"path");n&&(o.path=n),L(e,"default")&&(o.default=!0),L(e,"exact")&&(o.exact=!0),R(e,o,t);for(let n=0;n<e.childNodes.length;n++)o.routes.push(...M(e.childNodes[n],t,r));return[o]}if("redirect"===e.nodeName.toLowerCase())return r.redirects[C("/",x(e,"from"))]=C("/",x(e,"to")),[];if("undefined"!=typeof Node&&e instanceof Node){if(e.nodeType===Node.TEXT_NODE&&""===e.textContent.trim())return[];if(e.childNodes&&e.childNodes.length>0){e.routes=[];for(let o=0;o<e.childNodes.length;o++)e.routes.push(...M(e.childNodes[o],t,r))}return[e]}if(e.childNodes){const o={type:e.nodeName.toLowerCase(),routes:[],attrs:e.attrs};for(let n=0;n<e.childNodes.length;n++)o.routes.push(...M(e.childNodes[n],t,r));return[o]}return"#comment"===e.nodeName?[{type:"#comment",value:e.data}]:"#text"===e.nodeName?[{type:"#text",value:e.value}]:void 0}function R(e,t,r){const o=(x(e,"props")||"").split(",");for(let e=0;e<o.length;e++){const n=o[e].trim();if(0!==n.length)if(t.props||(t.props={}),r.props&&r.props.hasOwnProperty(n))t.props[n]=r.props[n];else{if(E)throw Error(`Prop '${n}' was not defined in the htmlLayoutData. Either remove this attribute from the HTML element or provide the prop's value`);t.props[n]=O}}}class j extends m.default{_processToken(e){if("IN_HEAD_MODE"!==this.insertionMode||"START_TAG_TOKEN"!==e.type||"fragment"!==e.tagName&&"assets"!==e.tagName)return super._processToken(e);this._appendElement(e,h.default.NAMESPACES.HTML),e.ackSelfClosing=!0}}const I="single-spa-layout (server):";function W(e,t){const r=D(e,t);if(r)return r;throw Error(`${I} could not find ${t} element in HTML`)}function D(e,t){const r=N.getTagName(e),o="template"===r?N.getChildNodes(N.getTemplateContent(e)):N.getChildNodes(e);if(r===t)return e;if(o)for(let e=0;e<o.length;e++){const r=D(o[e],t);if(r)return r}return null}const H=h.default.TAG_NAMES,q=h.default.NAMESPACES,_=/&/g,k=/\u00a0/g,F=/"/g,B=/</g,U=/>/g;function X(e){const{node:t,inRouterElement:r}=e;let o=N.getChildNodes(t);for(let t=0;t<o.length;t++){let n,a=o[t];if(a._originalNode&&(a=a._originalNode),!r&&G(a)?n=Y:!r&&K(a)?n=z:Q(a)?n=V:ee(a)?n=re:Z(a)?n=te:N.isElementNode(a)?n=oe:N.isTextNode(a)?n=ne:N.isCommentNode(a)?n=se:N.isDocumentTypeNode(a)&&(n=ie),!n)throw console.error(a),Error(`Unable to serialize node ${a.nodeName||a.nodeType||a.type}`);n({...e,node:a})}}function G(e){return"application"===N.getTagName(e)}function K(e){return"route"===N.getTagName(e)}function z(e){X({...e,node:e.node})}function Y({node:e,assetsStream:t,bodyStream:r,renderOptions:o,applicationPropPromises:n,propPromises:a,headerPromises:s}){const i=e.name,l="string"==typeof e.className&&e.className,d=e.props||{},u=Promise.all(Object.keys(d).map((e=>{let t;return t=d[e]===O?a[e]||(a[e]=o.retrieveProp(e)):d[e],Promise.resolve(t).then((t=>[e,t]))}))).then((e=>{const t={};return e.forEach((([e,r])=>{t[e]=r})),t.name=i,t}));let c,p,f;n[i]=u,s[i]=o.retrieveApplicationHeaders({appName:i,propsPromise:u});try{if(c=o.renderApplication({appName:i,propsPromise:u}),"function"==typeof c.then)p=y.default(),f=y.default(),c.then((e=>{const t=J(i,e);p.add(t.contentStream),f.add(t.assetStream)}),(e=>{p.add(ue(i,e)),f.add(ue(i,e))}));else{const e=J(i,c);p=e.contentStream,f=e.assetStream}}catch(e){p=ue(i,e),f=ue(i,e)}t.add(f),r.add(le(`<div id="single-spa-application:${i}"${l?` class="${l}"`:""}>`)),r.add(p),r.add(le("</div>"))}function J(e,t){let r,o;var n,a;return t?(r=de(null!==(n=t.content)&&void 0!==n?n:t,e),o=de(null!==(a=t.assets)&&void 0!==a?a:"",e)):(r=ue(e,Error("returned nothing")),o=ue(e,Error("returned nothing"))),{contentStream:r,assetStream:o}}function Q(e){return N.isElementNode(e)&&"ssl-router-content"===N.getTagName(e)}function V(e){const{renderOptions:t}=e,r=S(t.serverLayout.resolvedRoutes,t.urlPath);X({...e,node:{childNodes:r.routes}}),function({propPromises:e,bodyStream:t,nonce:r}){try{t.add(de((async()=>{const t=(await Promise.all(Object.entries(e).map((([e,t])=>t.then((t=>[e,t])))))).reduce(((e,[t,r])=>(e[t]=r,e)),{});return`<script${r?` nonce="${r}"`:""}>window.singleSpaLayoutData = ${JSON.stringify({props:t})}<\/script>`})()))}catch(e){t.add(ue("Serialize layout props",e))}}(e)}function Z(e){return N.isElementNode(e)&&"fragment"===N.getTagName(e)}function ee(e){return N.isElementNode(e)&&"assets"===N.getTagName(e)}function te({node:e,bodyStream:t,renderOptions:r}){const o=N.getAttrList(e).find((e=>"name"===e.name));if(!o.name)throw Error("<fragment> has unknown name");let n;try{n=de(r.renderFragment(o.value),`Fragment ${o.value}`)}catch(e){n=ue(`Fragment ${o.name}`,e)}t.add(n)}function re({assetsStream:e,bodyStream:t}){t.add(e)}function oe(e){const{node:t,bodyStream:r}=e,o=N.getTagName(t),n=N.getNamespaceURI(t);if(r.add(le(`<${o}`)),function({node:e,bodyStream:t}){const r=N.getAttrList(e)||[];for(let e=0,o=r.length;e<o;e++){const o=r[e],n=ae(o.value,!0);let a;o.namespace?o.namespace===q.XML?a="xml:"+o.name:o.namespace===q.XMLNS?("xmlns"!==o.name&&(a="xmlns:"),a=o.name):a=o.namespace===q.XLINK?"xlink:"+o.name:o.prefix+":"+o.name:a=o.name,t.add(le(` ${a}="${n}"`))}}(e),r.add(le(">")),o!==H.AREA&&o!==H.BASE&&o!==H.BASEFONT&&o!==H.BGSOUND&&o!==H.BR&&o!==H.COL&&o!==H.EMBED&&o!==H.FRAME&&o!==H.HR&&o!==H.IMG&&o!==H.INPUT&&o!==H.KEYGEN&&o!==H.LINK&&o!==H.META&&o!==H.PARAM&&o!==H.SOURCE&&o!==H.TRACK&&o!==H.WBR){const a=o===H.TEMPLATE&&n===q.HTML?N.getTemplateContent(t):t,s=e.inRouterElement||"single-spa-router"===o;X({...e,node:a,inRouterElement:s}),r.add(le(`</${o}>`))}}function ne({node:e,bodyStream:t}){const r=N.getTextNodeContent(e),o=N.getParentNode(e);let n=null;o&&N.isElementNode(o)&&(n=N.getTagName(o)),n===H.STYLE||n===H.SCRIPT||n===H.XMP||n===H.IFRAME||n===H.NOEMBED||n===H.NOFRAMES||n===H.PLAINTEXT||n===H.NOSCRIPT?t.add(le(r)):t.add(le(ae(r,!1)))}function ae(e,t){return e=e.replace(_,"&amp;").replace(k,"&nbsp;"),t?e.replace(F,"&quot;"):e.replace(B,"&lt;").replace(U,"&gt;")}function se({node:e,bodyStream:t}){t.add(le(`\x3c!--${N.getCommentNodeContent(e)}--\x3e`))}function ie({node:e,bodyStream:t}){const r=N.getDocumentTypeNodeName(e);t.add(le(`<${g.default.serializeContent(r,null,null)}>`))}function le(e){const t=new l.Readable({read(){}});return t.push(e),t.push(null),t}function de(e,t){let r;if(e&&"function"==typeof e.then){const o=e;r=y.default(),o.then((e=>{r.add("string"==typeof e?le(e):e)}),(e=>{r.add(ue(t,e))}))}else r="string"==typeof e?le(e):e;return r}function ue(e,t){return console.error(`${e} failed to render.`),console.error(t),le("")}e.constructServerLayout=function(e){if(!e)throw Error(`${I} templateOptions is required`);let t,r;if(e.hasOwnProperty("html"))t=e.html,T("html",t);else{if(!e.hasOwnProperty("filePath"))throw Error(`${I} either templateOptions.html or templateOptions.filePath is required`);t=f.default.readFileSync(p.default.resolve(process.cwd(),e.filePath),"utf-8").toString(),T("filePath",t)}const o=new j;try{r=o.parse(t)}catch(e){throw console.error(`${I} failed to parse HTML template with parse5.`),e}const a=function(e,t){if(e&&e.nodeName||"string"==typeof e){if(E&&!t&&window.singleSpaLayoutData&&(t=window.singleSpaLayoutData),"string"==typeof e){if(!E)throw Error("calling constructRoutes with a string on the server is not yet supported");if(!(e=(new DOMParser).parseFromString(e,"text/html").documentElement.querySelector("single-spa-router")))throw Error("constructRoutes should be called with a string HTML document that contains a <single-spa-router> element.")}e=function(e,t={}){if("template"===e.nodeName.toLowerCase()&&(e=(e.content||e).querySelector("single-spa-router")),"single-spa-router"!==e.nodeName.toLowerCase())throw Error(`single-spa-layout: The HTMLElement passed to constructRoutes must be <single-spa-router> or a <template> containing the router. Received ${e.nodeName}`);E&&e.isConnected&&e.parentNode.removeChild(e);const r={routes:[],redirects:{}};x(e,"mode")&&(r.mode=x(e,"mode")),x(e,"base")&&(r.base=x(e,"base")),x(e,"containerEl")&&(r.containerEl=x(e,"containerEl"));for(let o=0;o<e.childNodes.length;o++)r.routes.push(...M(e.childNodes[o],t,r));return r}(e,t)}else if(t)throw Error("constructRoutes should be called either with an HTMLElement and layoutData, or a single json object.");return function(e){b("routesConfig",e);const t=e.disableWarnings;var r;if(w("routesConfig",e,["mode","base","containerEl","routes","disableWarnings","redirects"],t),e.hasOwnProperty("containerEl")?function(e,t){let r;if(r="string"==typeof t?""===t.trim():!(E&&t instanceof HTMLElement),r)throw Error(`Invalid routesConfig.containerEl: received ${t} but expected either non-blank string or HTMLElement`)}(0,e.containerEl):e.containerEl="body",e.hasOwnProperty("mode")||(e.mode="history"),function(e,t,r){if(r.indexOf(t)<0)throw Error(`Invalid routesConfig.mode: received '${t}' but expected ${r.join(", ")}`)}(0,e.mode,["history","hash"]),e.hasOwnProperty("base")?(T("routesConfig.base",e.base),e.base=(0!==(r=e.base).indexOf("/")&&(r="/"+r),"/"!==r[r.length-1]&&(r+="/"),r)):e.base="/",e.hasOwnProperty("redirects")){b("routesConfig.redirects",e.redirects);for(let t in e.redirects){const r=e.redirects[t];$("routesConfig.redirects key",t),$(`routesConfig.redirects['${t}']`,r)}}const o=E?window.location.pathname:"/",a="hash"===e.mode?o+"#":"";P("routesConfig.routes",e.routes,(function e(r,o,{parentPath:a,siblingActiveWhens:s,parentActiveWhen:i}){if(b(o,r),"application"===r.type)w(o,r,["type","name","props","loader","error","className"],t),r.props&&b(`${o}.props`,r.props),T(`${o}.name`,r.name);else if("route"===r.type){w(o,r,["type","path","routes","props","default","exact"],t),r.hasOwnProperty("exact")&&v(`${o}.exact`,r.exact);const l=r.hasOwnProperty("path"),d=r.hasOwnProperty("default");let u;if(l)T(`${o}.path`,r.path),u=C(a,r.path),r.activeWhen=n.pathToActiveWhen(u,r.exact),s.push(r.activeWhen);else{if(!d)throw Error(`Invalid ${o}: routes must have either a path or default property.`);v(`${o}.default`,r.default),u=a,r.activeWhen=function(e,t){return r=>t(r)&&!e.some((e=>e(r)))}(s,i)}if(l&&d&&r.default)throw Error(`Invalid ${o}: cannot have both path and set default to true.`);r.routes&&P(`${o}.routes`,r.routes,e,{parentPath:u,siblingActiveWhens:[],parentActiveWhen:r.activeWhen})}else{if("undefined"!=typeof Node&&r instanceof Node);else for(let e in r)"routes"!==e&&"attrs"!==e&&T(`${o}['${e}']`,r[e],!1);r.routes&&P(`${o}.routes`,r.routes,e,{parentPath:a,siblingActiveWhens:s,parentActiveWhen:i})}}),{parentPath:a+e.base,parentActiveWhen:()=>!0,siblingActiveWhens:[]}),delete e.disableWarnings}(e),e}(W(r,"single-spa-router"));let s=a.containerEl;"string"==typeof s&&(s=W(r,s));const i=N.createElement("ssl-router-content",null,[]),l=N.getFirstChild(s);return l?N.insertBefore(s,i,l):N.appendChild(s,i),{parsedDocument:r,resolvedRoutes:a}},e.sendLayoutHTTPResponse=async function(e){if(!e)throw Error("single-spa-layout (server): must provide renderOptions");const t=e.serverLayout.resolvedRoutes.redirects;for(let r in t){const o=t[r];if(e.urlPath===r)return void e.res.redirect(o)}const r={},o={},n=y.default({pipeError:!0}),a=y.default({pipeError:!0});X({node:e.serverLayout.parsedDocument,assetsStream:n,bodyStream:a,renderOptions:e,propPromises:{},applicationPropPromises:r,headerPromises:o,inRouterElement:!1,nonce:e.nonce});const s=await Promise.all(Object.keys(o).map((async e=>{const[t,n]=await Promise.all([o[e],r[e]]);return{appHeaders:t,appProps:n}}))),i=e.assembleFinalHeaders(s);for(let t in i)e.res.setHeader(t,i[t]);a.pipe(e.res)},Object.defineProperty(e,"__esModule",{value:!0})}));
