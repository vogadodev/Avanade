/* single-spa-layout@3.0.0 - esm */
import e from"parse5/lib/tree-adapters/default.js";import t from"path";import r from"fs";import{pathToActiveWhen as o}from"single-spa";import n from"parse5/lib/parser/index.js";import s from"parse5/lib/common/html.js";import a from"parse5/lib/common/doctype.js";import{Readable as i}from"stream";import l from"merge2";const d=Object.assign({},e,{isElementNode:t=>e.isElementNode(t)||t.type&&!t.type.startsWith("#"),getChildNodes:t=>e.getChildNodes(t)||t.routes,getTagName:t=>e.getTagName(t)||t.type,isCommentNode:t=>e.isCommentNode(t)||"#comment"===t.type,isTextNode:t=>e.isTextNode(t)||"#text"===t.type,getCommentNodeContent:t=>e.getCommentNodeContent(t)||t.value}),c="undefined"!=typeof window;function p(e,t){if("object"!=typeof t||Array.isArray(t)||null===t)throw Error(`Invalid ${e}: received ${Array.isArray(t)?"array":t} but expected a plain object`)}function u(e,t){if("boolean"!=typeof t)throw Error(`Invalid ${e}: received ${typeof t}, but expected a boolean`)}function m(e,t,r,o){if(o)return;const n=Object.keys(t),s=[];n.forEach((e=>{r.indexOf(e)<0&&s.push(e)})),s.length>0&&console.warn(Error(`Invalid ${e}: received invalid properties '${s.join(", ")}', but valid properties are ${r.join(", ")}`))}function f(e,t,r=!0){if("string"!=typeof t||r&&""===t.trim())throw Error(`Invalid ${e}: received '${t}', but expected a${r?" non-blank":""} string`)}function h(e,t){if(f(e,t),t.indexOf("/")<0)throw Error(`Invalid ${e}: received '${t}', but expected an absolute path that starts with /`)}function g(e,t,r,...o){if(!Array.isArray(t)&&("object"!=typeof typeof t||"number"!==t.length))throw Error(`Invalid ${e}: received '${t}', but expected an array`);for(let n=0;n<t.length;n++)r(t[n],`${e}[${n}]`,...o)}function y(e,t){f("path",t);const r={...e},o=e.base.slice(0,e.base.length-1);if(0===t.indexOf(o)){const o=c?window.location.origin:"http://localhost",n=new URL(E(o,t));r.routes=N(n,e.routes)}else r.routes=[];return r}function N(e,t){const r=[];return t.forEach((t=>{"application"===t.type?r.push(t):"route"===t.type?t.activeWhen(e)&&r.push({...t,routes:N(e,t.routes)}):Array.isArray(t.routes)?r.push({...t,routes:N(e,t.routes)}):r.push(t)})),r}function E(e,t){let r;return r="/"===e.substr(-1)?"/"===t[0]?e+t.slice(1):e+t:"/"===t[0]?e+t:e+"/"+t,"/"===r.substr(-1)&&r.length>1&&(r=r.slice(0,r.length-1)),r}const w="undefined"!=typeof Symbol?Symbol():"@";function b(e,t){if(c)return e.getAttribute(t);{const r=function(e,t){for(let r=0;r<e.length;r++)if(t(e[r]))return e[r];return null}(e.attrs,(e=>e.name===t.toLowerCase()));return r?r.value:null}}function v(e,t){return c?e.hasAttribute(t):e.attrs.some((e=>e.name===t))}function $(e,t,r){if("application"===e.nodeName.toLowerCase()){if(e.childNodes.length>0)throw Error("<application> elements must not have childNodes. You must put in a closing </application> - self closing is not allowed");const r={type:"application",name:b(e,"name")},o=b(e,"loader");if(o)if(t.loaders&&t.loaders.hasOwnProperty(o))r.loader=t.loaders[o];else if(c)throw Error(`Application loader '${o}' was not defined in the htmlLayoutData`);const n=b(e,"error");if(n)if(t.errors&&t.errors.hasOwnProperty(n))r.error=t.errors[n];else if(c)throw Error(`Application error handler '${o}' was not defined in the htmlLayoutData`);const s=b(e,"class");return s&&(r.className=s),P(e,r,t),[r]}if("route"===e.nodeName.toLowerCase()){const o={type:"route",routes:[]},n=b(e,"path");n&&(o.path=n),v(e,"default")&&(o.default=!0),v(e,"exact")&&(o.exact=!0),P(e,o,t);for(let n=0;n<e.childNodes.length;n++)o.routes.push(...$(e.childNodes[n],t,r));return[o]}if("redirect"===e.nodeName.toLowerCase())return r.redirects[E("/",b(e,"from"))]=E("/",b(e,"to")),[];if("undefined"!=typeof Node&&e instanceof Node){if(e.nodeType===Node.TEXT_NODE&&""===e.textContent.trim())return[];if(e.childNodes&&e.childNodes.length>0){e.routes=[];for(let o=0;o<e.childNodes.length;o++)e.routes.push(...$(e.childNodes[o],t,r))}return[e]}if(e.childNodes){const o={type:e.nodeName.toLowerCase(),routes:[],attrs:e.attrs};for(let n=0;n<e.childNodes.length;n++)o.routes.push(...$(e.childNodes[n],t,r));return[o]}return"#comment"===e.nodeName?[{type:"#comment",value:e.data}]:"#text"===e.nodeName?[{type:"#text",value:e.value}]:void 0}function P(e,t,r){const o=(b(e,"props")||"").split(",");for(let e=0;e<o.length;e++){const n=o[e].trim();if(0!==n.length)if(t.props||(t.props={}),r.props&&r.props.hasOwnProperty(n))t.props[n]=r.props[n];else{if(c)throw Error(`Prop '${n}' was not defined in the htmlLayoutData. Either remove this attribute from the HTML element or provide the prop's value`);t.props[n]=w}}}class T extends n{_processToken(e){if("IN_HEAD_MODE"!==this.insertionMode||"START_TAG_TOKEN"!==e.type||"fragment"!==e.tagName&&"assets"!==e.tagName)return super._processToken(e);this._appendElement(e,s.NAMESPACES.HTML),e.ackSelfClosing=!0}}const C="single-spa-layout (server):";function S(e){if(!e)throw Error(`${C} templateOptions is required`);let n,s;if(e.hasOwnProperty("html"))n=e.html,f("html",n);else{if(!e.hasOwnProperty("filePath"))throw Error(`${C} either templateOptions.html or templateOptions.filePath is required`);n=r.readFileSync(t.resolve(process.cwd(),e.filePath),"utf-8").toString(),f("filePath",n)}const a=new T;try{s=a.parse(n)}catch(e){throw console.error(`${C} failed to parse HTML template with parse5.`),e}const i=function(e,t){if(e&&e.nodeName||"string"==typeof e){if(c&&!t&&window.singleSpaLayoutData&&(t=window.singleSpaLayoutData),"string"==typeof e){if(!c)throw Error("calling constructRoutes with a string on the server is not yet supported");if(!(e=(new DOMParser).parseFromString(e,"text/html").documentElement.querySelector("single-spa-router")))throw Error("constructRoutes should be called with a string HTML document that contains a <single-spa-router> element.")}e=function(e,t={}){if("template"===e.nodeName.toLowerCase()&&(e=(e.content||e).querySelector("single-spa-router")),"single-spa-router"!==e.nodeName.toLowerCase())throw Error(`single-spa-layout: The HTMLElement passed to constructRoutes must be <single-spa-router> or a <template> containing the router. Received ${e.nodeName}`);c&&e.isConnected&&e.parentNode.removeChild(e);const r={routes:[],redirects:{}};b(e,"mode")&&(r.mode=b(e,"mode")),b(e,"base")&&(r.base=b(e,"base")),b(e,"containerEl")&&(r.containerEl=b(e,"containerEl"));for(let o=0;o<e.childNodes.length;o++)r.routes.push(...$(e.childNodes[o],t,r));return r}(e,t)}else if(t)throw Error("constructRoutes should be called either with an HTMLElement and layoutData, or a single json object.");return function(e){p("routesConfig",e);const t=e.disableWarnings;var r;if(m("routesConfig",e,["mode","base","containerEl","routes","disableWarnings","redirects"],t),e.hasOwnProperty("containerEl")?function(e,t){let r;if(r="string"==typeof t?""===t.trim():!(c&&t instanceof HTMLElement),r)throw Error(`Invalid routesConfig.containerEl: received ${t} but expected either non-blank string or HTMLElement`)}(0,e.containerEl):e.containerEl="body",e.hasOwnProperty("mode")||(e.mode="history"),function(e,t,r){if(r.indexOf(t)<0)throw Error(`Invalid routesConfig.mode: received '${t}' but expected ${r.join(", ")}`)}(0,e.mode,["history","hash"]),e.hasOwnProperty("base")?(f("routesConfig.base",e.base),e.base=(0!==(r=e.base).indexOf("/")&&(r="/"+r),"/"!==r[r.length-1]&&(r+="/"),r)):e.base="/",e.hasOwnProperty("redirects")){p("routesConfig.redirects",e.redirects);for(let t in e.redirects){const r=e.redirects[t];h("routesConfig.redirects key",t),h(`routesConfig.redirects['${t}']`,r)}}const n=c?window.location.pathname:"/",s="hash"===e.mode?n+"#":"";g("routesConfig.routes",e.routes,(function e(r,n,{parentPath:s,siblingActiveWhens:a,parentActiveWhen:i}){if(p(n,r),"application"===r.type)m(n,r,["type","name","props","loader","error","className"],t),r.props&&p(`${n}.props`,r.props),f(`${n}.name`,r.name);else if("route"===r.type){m(n,r,["type","path","routes","props","default","exact"],t),r.hasOwnProperty("exact")&&u(`${n}.exact`,r.exact);const l=r.hasOwnProperty("path"),d=r.hasOwnProperty("default");let c;if(l)f(`${n}.path`,r.path),c=E(s,r.path),r.activeWhen=o(c,r.exact),a.push(r.activeWhen);else{if(!d)throw Error(`Invalid ${n}: routes must have either a path or default property.`);u(`${n}.default`,r.default),c=s,r.activeWhen=function(e,t){return r=>t(r)&&!e.some((e=>e(r)))}(a,i)}if(l&&d&&r.default)throw Error(`Invalid ${n}: cannot have both path and set default to true.`);r.routes&&g(`${n}.routes`,r.routes,e,{parentPath:c,siblingActiveWhens:[],parentActiveWhen:r.activeWhen})}else{if("undefined"!=typeof Node&&r instanceof Node);else for(let e in r)"routes"!==e&&"attrs"!==e&&f(`${n}['${e}']`,r[e],!1);r.routes&&g(`${n}.routes`,r.routes,e,{parentPath:s,siblingActiveWhens:a,parentActiveWhen:i})}}),{parentPath:s+e.base,parentActiveWhen:()=>!0,siblingActiveWhens:[]}),delete e.disableWarnings}(e),e}(A(s,"single-spa-router"));let l=i.containerEl;"string"==typeof l&&(l=A(s,l));const y=d.createElement("ssl-router-content",null,[]),N=d.getFirstChild(l);return N?d.insertBefore(l,y,N):d.appendChild(l,y),{parsedDocument:s,resolvedRoutes:i}}function A(e,t){const r=O(e,t);if(r)return r;throw Error(`${C} could not find ${t} element in HTML`)}function O(e,t){const r=d.getTagName(e),o="template"===r?d.getChildNodes(d.getTemplateContent(e)):d.getChildNodes(e);if(r===t)return e;if(o)for(let e=0;e<o.length;e++){const r=O(o[e],t);if(r)return r}return null}const x=s.TAG_NAMES,L=s.NAMESPACES,M=/&/g,R=/\u00a0/g,I=/"/g,D=/</g,W=/>/g;async function j(e){if(!e)throw Error("single-spa-layout (server): must provide renderOptions");const t=e.serverLayout.resolvedRoutes.redirects;for(let r in t){const o=t[r];if(e.urlPath===r)return void e.res.redirect(o)}const r={},o={},n=l({pipeError:!0}),s=l({pipeError:!0});H({node:e.serverLayout.parsedDocument,assetsStream:n,bodyStream:s,renderOptions:e,propPromises:{},applicationPropPromises:r,headerPromises:o,inRouterElement:!1,nonce:e.nonce});const a=await Promise.all(Object.keys(o).map((async e=>{const[t,n]=await Promise.all([o[e],r[e]]);return{appHeaders:t,appProps:n}}))),i=e.assembleFinalHeaders(a);for(let t in i)e.res.setHeader(t,i[t]);s.pipe(e.res)}function H(e){const{node:t,inRouterElement:r}=e;let o=d.getChildNodes(t);for(let t=0;t<o.length;t++){let n,s=o[t];if(s._originalNode&&(s=s._originalNode),!r&&k(s)?n=B:!r&&F(s)?n=_:X(s)?n=q:K(s)?n=Y:G(s)?n=z:d.isElementNode(s)?n=J:d.isTextNode(s)?n=Q:d.isCommentNode(s)?n=Z:d.isDocumentTypeNode(s)&&(n=ee),!n)throw console.error(s),Error(`Unable to serialize node ${s.nodeName||s.nodeType||s.type}`);n({...e,node:s})}}function k(e){return"application"===d.getTagName(e)}function F(e){return"route"===d.getTagName(e)}function _(e){H({...e,node:e.node})}function B({node:e,assetsStream:t,bodyStream:r,renderOptions:o,applicationPropPromises:n,propPromises:s,headerPromises:a}){const i=e.name,d="string"==typeof e.className&&e.className,c=e.props||{},p=Promise.all(Object.keys(c).map((e=>{let t;return t=c[e]===w?s[e]||(s[e]=o.retrieveProp(e)):c[e],Promise.resolve(t).then((t=>[e,t]))}))).then((e=>{const t={};return e.forEach((([e,r])=>{t[e]=r})),t.name=i,t}));let u,m,f;n[i]=p,a[i]=o.retrieveApplicationHeaders({appName:i,propsPromise:p});try{if(u=o.renderApplication({appName:i,propsPromise:p}),"function"==typeof u.then)m=l(),f=l(),u.then((e=>{const t=U(i,e);m.add(t.contentStream),f.add(t.assetStream)}),(e=>{m.add(oe(i,e)),f.add(oe(i,e))}));else{const e=U(i,u);m=e.contentStream,f=e.assetStream}}catch(e){m=oe(i,e),f=oe(i,e)}t.add(f),r.add(te(`<div id="single-spa-application:${i}"${d?` class="${d}"`:""}>`)),r.add(m),r.add(te("</div>"))}function U(e,t){let r,o;var n,s;return t?(r=re(null!==(n=t.content)&&void 0!==n?n:t,e),o=re(null!==(s=t.assets)&&void 0!==s?s:"",e)):(r=oe(e,Error("returned nothing")),o=oe(e,Error("returned nothing"))),{contentStream:r,assetStream:o}}function X(e){return d.isElementNode(e)&&"ssl-router-content"===d.getTagName(e)}function q(e){const{renderOptions:t}=e,r=y(t.serverLayout.resolvedRoutes,t.urlPath);H({...e,node:{childNodes:r.routes}}),function({propPromises:e,bodyStream:t,nonce:r}){try{t.add(re((async()=>{const t=(await Promise.all(Object.entries(e).map((([e,t])=>t.then((t=>[e,t])))))).reduce(((e,[t,r])=>(e[t]=r,e)),{});return`<script${r?` nonce="${r}"`:""}>window.singleSpaLayoutData = ${JSON.stringify({props:t})}<\/script>`})()))}catch(e){t.add(oe("Serialize layout props",e))}}(e)}function G(e){return d.isElementNode(e)&&"fragment"===d.getTagName(e)}function K(e){return d.isElementNode(e)&&"assets"===d.getTagName(e)}function z({node:e,bodyStream:t,renderOptions:r}){const o=d.getAttrList(e).find((e=>"name"===e.name));if(!o.name)throw Error("<fragment> has unknown name");let n;try{n=re(r.renderFragment(o.value),`Fragment ${o.value}`)}catch(e){n=oe(`Fragment ${o.name}`,e)}t.add(n)}function Y({assetsStream:e,bodyStream:t}){t.add(e)}function J(e){const{node:t,bodyStream:r}=e,o=d.getTagName(t),n=d.getNamespaceURI(t);if(r.add(te(`<${o}`)),function({node:e,bodyStream:t}){const r=d.getAttrList(e)||[];for(let e=0,o=r.length;e<o;e++){const o=r[e],n=V(o.value,!0);let s;o.namespace?o.namespace===L.XML?s="xml:"+o.name:o.namespace===L.XMLNS?("xmlns"!==o.name&&(s="xmlns:"),s=o.name):s=o.namespace===L.XLINK?"xlink:"+o.name:o.prefix+":"+o.name:s=o.name,t.add(te(` ${s}="${n}"`))}}(e),r.add(te(">")),o!==x.AREA&&o!==x.BASE&&o!==x.BASEFONT&&o!==x.BGSOUND&&o!==x.BR&&o!==x.COL&&o!==x.EMBED&&o!==x.FRAME&&o!==x.HR&&o!==x.IMG&&o!==x.INPUT&&o!==x.KEYGEN&&o!==x.LINK&&o!==x.META&&o!==x.PARAM&&o!==x.SOURCE&&o!==x.TRACK&&o!==x.WBR){const s=o===x.TEMPLATE&&n===L.HTML?d.getTemplateContent(t):t,a=e.inRouterElement||"single-spa-router"===o;H({...e,node:s,inRouterElement:a}),r.add(te(`</${o}>`))}}function Q({node:e,bodyStream:t}){const r=d.getTextNodeContent(e),o=d.getParentNode(e);let n=null;o&&d.isElementNode(o)&&(n=d.getTagName(o)),n===x.STYLE||n===x.SCRIPT||n===x.XMP||n===x.IFRAME||n===x.NOEMBED||n===x.NOFRAMES||n===x.PLAINTEXT||n===x.NOSCRIPT?t.add(te(r)):t.add(te(V(r,!1)))}function V(e,t){return e=e.replace(M,"&amp;").replace(R,"&nbsp;"),t?e.replace(I,"&quot;"):e.replace(D,"&lt;").replace(W,"&gt;")}function Z({node:e,bodyStream:t}){t.add(te(`\x3c!--${d.getCommentNodeContent(e)}--\x3e`))}function ee({node:e,bodyStream:t}){const r=d.getDocumentTypeNodeName(e);t.add(te(`<${a.serializeContent(r,null,null)}>`))}function te(e){const t=new i({read(){}});return t.push(e),t.push(null),t}function re(e,t){let r;if(e&&"function"==typeof e.then){const o=e;r=l(),o.then((e=>{r.add("string"==typeof e?te(e):e)}),(e=>{r.add(oe(t,e))}))}else r="string"==typeof e?te(e):e;return r}function oe(e,t){return console.error(`${e} failed to render.`),console.error(t),te("")}export{S as constructServerLayout,j as sendLayoutHTTPResponse};
